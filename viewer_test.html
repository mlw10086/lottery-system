<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§‚ä¼—ç«¯æƒé‡æµ‹è¯•</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ² è§‚ä¼—ç«¯æƒé‡æµ‹è¯•</h1>
        </header>

        <main>
            <!-- æƒé‡æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="weights-display">
                <h3>ğŸ“Š å®æ—¶æƒé‡å˜åŒ–</h3>
                <div id="weightsChart" class="weights-chart">
                    <p>æ­£åœ¨åŠ è½½æƒé‡æ˜¾ç¤º...</p>
                </div>
            </div>

            <!-- æµ‹è¯•æ§åˆ¶ -->
            <div style="background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 20px; margin-top: 20px;">
                <h3>æµ‹è¯•æ§åˆ¶</h3>
                <button onclick="testWeights1()" style="margin: 5px; padding: 10px;">æµ‹è¯•ç¬¬ä¸€è½®æƒé‡</button>
                <button onclick="testWeights2()" style="margin: 5px; padding: 10px;">æµ‹è¯•ç¬¬äºŒè½®æƒé‡</button>
                <button onclick="testWaiting()" style="margin: 5px; padding: 10px;">æµ‹è¯•ç­‰å¾…çŠ¶æ€</button>
                <button onclick="startAutoUpdate()" style="margin: 5px; padding: 10px;">å¼€å§‹è‡ªåŠ¨æ›´æ–°</button>
                <button onclick="stopAutoUpdate()" style="margin: 5px; padding: 10px;">åœæ­¢è‡ªåŠ¨æ›´æ–°</button>
            </div>

            <!-- è°ƒè¯•ä¿¡æ¯ -->
            <div id="debugInfo" style="background: #f0f0f0; padding: 15px; margin-top: 20px; border-radius: 8px;">
                <h4>è°ƒè¯•ä¿¡æ¯</h4>
                <div id="debugContent">ç­‰å¾…æµ‹è¯•...</div>
            </div>
        </main>
    </div>

    <script src="js/lottery.js"></script>
    <script>
        let testInterval = null;
        let testViewer = null;

        // åˆ›å»ºæµ‹è¯•ç”¨çš„è§‚ä¼—å®ä¾‹
        class TestViewer {
            constructor() {
                this.cities = [];
                this.loadCities();
            }

            async loadCities() {
                try {
                    const response = await fetch('data/cities.json');
                    const data = await response.json();
                    this.cities = data.cities;
                    this.log('åŸå¸‚æ•°æ®åŠ è½½æˆåŠŸ: ' + this.cities.length + ' ä¸ªåŸå¸‚');
                } catch (error) {
                    this.log('åŸå¸‚æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
                }
            }

            updateViewerWeightsDisplay(phase = 'ç¬¬ä¸€è½®') {
                const weightsChart = document.getElementById('weightsChart');
                if (!weightsChart) return;
                
                let weights = [];
                if (phase === 'ç¬¬ä¸€è½®' && this.cities) {
                    weights = this.cities.map((city, index) => ({
                        name: city.name,
                        weight: Math.random() * 100,
                        index: index
                    }));
                } else if (phase === 'ç¬¬äºŒè½®') {
                    // æ¨¡æ‹Ÿç¬¬äºŒè½®çš„5ä¸ªåŸå¸‚
                    const selectedCities = this.cities.slice(0, 5);
                    weights = selectedCities.map((city, index) => ({
                        name: city.name,
                        weight: Math.random() * 100,
                        index: index
                    }));
                }
                
                if (weights.length > 0) {
                    this.displayViewerWeightsChart(weights, weightsChart, phase);
                    this.log('æƒé‡æ˜¾ç¤ºæ›´æ–°: ' + phase + ', ' + weights.length + ' ä¸ªåŸå¸‚');
                }
            }

            displayViewerWeightsChart(weights, container, phase = 'ç¬¬ä¸€è½®') {
                if (!weights || weights.length === 0) return;

                const totalWeight = weights.reduce((sum, item) => sum + item.weight, 0);

                // æŒ‰æƒé‡å¤§å°æ’åºï¼ˆä»é«˜åˆ°ä½ï¼‰
                const sortedWeights = weights.map((item, originalIndex) => ({
                    ...item,
                    originalIndex: originalIndex
                })).sort((a, b) => b.weight - a.weight);

                container.innerHTML = `
                    <h4>ğŸ§ª ${phase}æƒé‡åˆ†å¸ƒ (æµ‹è¯•æ¨¡å¼ - æŒ‰æ¦‚ç‡æ’åº)</h4>
                    <div class="weights-bars">
                        ${sortedWeights.map((item, sortedIndex) => {
                            const percentage = ((item.weight / totalWeight) * 100).toFixed(1);
                            const colorPair = this.getColorPair(item.originalIndex);
                            const rankIcon = sortedIndex < 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][sortedIndex] : `#${sortedIndex + 1}`;
                            return `
                                <div class="weight-item ${sortedIndex < 3 ? 'top-rank' : ''}">
                                    <div class="weight-label">
                                        <span class="city-name">
                                            <span class="rank-icon">${rankIcon}</span>
                                            ${item.name}
                                        </span>
                                        <span class="weight-value">${percentage}%</span>
                                    </div>
                                    <div class="weight-bar-container">
                                        <div class="weight-bar-fill"
                                             style="width: ${percentage}%;
                                                    --bar-color: ${colorPair.main};
                                                    --bar-color-light: ${colorPair.light};
                                                    background: linear-gradient(90deg, ${colorPair.main}, ${colorPair.light});"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="weights-info">
                        <small>ğŸ“Š æŒ‰ä¸­å¥–æ¦‚ç‡æ’åº | ğŸ§ª æµ‹è¯•æ¨¡å¼ - éªŒè¯æƒé‡æ˜¾ç¤ºåŠŸèƒ½</small>
                    </div>
                `;
            }

            getColorPair(index) {
                const colorPairs = [
                    { main: '#667eea', light: '#764ba2' },
                    { main: '#f093fb', light: '#f5576c' },
                    { main: '#4facfe', light: '#00f2fe' },
                    { main: '#43e97b', light: '#38f9d7' },
                    { main: '#fad0c4', light: '#ffd1ff' },
                    { main: '#a8edea', light: '#fed6e3' },
                    { main: '#ffecd2', light: '#fcb69f' },
                    { main: '#ff9a9e', light: '#fecfef' },
                    { main: '#a18cd1', light: '#fbc2eb' },
                    { main: '#fad0c4', light: '#f8ad9d' }
                ];
                return colorPairs[index % colorPairs.length];
            }

            showWaitingWeights() {
                const weightsChart = document.getElementById('weightsChart');
                if (!weightsChart) return;
                
                weightsChart.innerHTML = `
                    <h4>ğŸ² æƒé‡åˆ†å¸ƒç³»ç»Ÿ (æµ‹è¯•)</h4>
                    <div class="weights-info">
                        <div style="text-align: center; padding: 40px 20px;">
                            <div style="font-size: 3em; margin-bottom: 15px;">â³</div>
                            <h3 style="color: #4a5568; margin-bottom: 10px;">æµ‹è¯•ç­‰å¾…çŠ¶æ€</h3>
                            <p style="color: #718096; margin-bottom: 20px;">ç‚¹å‡»æµ‹è¯•æŒ‰é’®æŸ¥çœ‹æƒé‡æ˜¾ç¤º</p>
                        </div>
                    </div>
                `;
            }

            log(message) {
                const debugContent = document.getElementById('debugContent');
                const time = new Date().toLocaleTimeString();
                debugContent.innerHTML += `<div>[${time}] ${message}</div>`;
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }

        function testWeights1() {
            if (!testViewer) testViewer = new TestViewer();
            testViewer.updateViewerWeightsDisplay('ç¬¬ä¸€è½®');
        }

        function testWeights2() {
            if (!testViewer) testViewer = new TestViewer();
            testViewer.updateViewerWeightsDisplay('ç¬¬äºŒè½®');
        }

        function testWaiting() {
            if (!testViewer) testViewer = new TestViewer();
            testViewer.showWaitingWeights();
        }

        function startAutoUpdate() {
            if (testInterval) return;
            if (!testViewer) testViewer = new TestViewer();
            
            testInterval = setInterval(() => {
                const phases = ['ç¬¬ä¸€è½®', 'ç¬¬äºŒè½®'];
                const phase = phases[Math.floor(Math.random() * phases.length)];
                testViewer.updateViewerWeightsDisplay(phase);
            }, 500);
            
            testViewer.log('å¼€å§‹è‡ªåŠ¨æ›´æ–°æƒé‡');
        }

        function stopAutoUpdate() {
            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
                if (testViewer) testViewer.log('åœæ­¢è‡ªåŠ¨æ›´æ–°æƒé‡');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            testViewer = new TestViewer();
            setTimeout(() => {
                testViewer.showWaitingWeights();
            }, 500);
        };
    </script>
</body>
</html>
